<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zero Draft - 写出你的第零稿</title>

  <!-- 字体加载 -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-webfont@1.1.0/style.css" rel="stylesheet">

  <!-- 样式 -->
  <link rel="stylesheet" href="./src/styles/global.css">
  <link rel="stylesheet" href="./src/styles/animations.css">

  <!-- Datastar -->
  <script type="module" src="datastar-pro.js"></script>
  <script type="module" src="datastar-inspector.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
    }
  </style>
</head>

<body data-signals="{
    screen: 'idle',
    duration: 900,
    elapsed: 0,
    content: '',
    savedContent: '',
    sessionActive: false,
    lastInputTime: 0,
    dangerActive: false,
    wordCount: 0,
    copied: false
  }">

  <!-- 初始界面 (Idle Screen) -->
  <div id="idle-screen" class="centered" data-show="$screen === 'idle'">
    <h1 class="title">Zero Draft</h1>
    <p class="tagline">写出你的第零稿</p>

    <div class="action-row">
      <select class="duration-dropdown" data-on:change="$duration = parseInt(el.value)">
        <option value="5">5 秒 (测试)</option>
        <option value="180">3 分钟</option>
        <option value="300">5 分钟</option>
        <option value="600">10 分钟</option>
        <option value="900" selected>15 分钟</option>
        <option value="1200">20 分钟</option>
        <option value="1800">30 分钟</option>
        <option value="3600">60 分钟</option>
      </select>

      <button class="btn-primary"
        data-on:click="$screen = 'writing'; $sessionActive = true; $elapsed = 0; $lastInputTime = Date.now(); $dangerActive = false; setTimeout(() => { const el = document.querySelector('.writing-content'); el.innerText = $content; el.focus(); if ($content) { const range = document.createRange(); range.selectNodeContents(el); range.collapse(false); const sel = window.getSelection(); sel.removeAllRanges(); sel.addRange(range); el.classList.toggle('has-multiple-lines', $content.split(/\r?\n/).length > 1); } }, 100)">开始写作 →</button>
    </div>
  </div>

  <!-- 写作界面 (Writing Screen) -->
  <div id="writing-screen" data-show="$screen === 'writing'" style="display: none">
    <!-- 进度条 -->
    <div class="progress-bar">
      <div class="progress-fill" data-style:width="($elapsed / $duration * 100) + '%'"></div>
    </div>

    <!-- 计时器 -->
    <div class="timer"
      data-text="String(Math.floor($elapsed / 60)).padStart(2, '0') + ':' + String($elapsed % 60).padStart(2, '0') + ' / ' + String(Math.floor($duration / 60)).padStart(2, '0') + ':' + String($duration % 60).padStart(2, '0')">
      00:00 / 15:00</div>

    <!-- 主计时器：每秒递增 elapsed，检查危险状态和完成状态 -->
    <div data-on-interval__duration.1s="
        if (!$sessionActive) return;
        $elapsed++;
        const idleTime = (Date.now() - $lastInputTime) / 1000;
        $dangerActive = idleTime >= 5;
        if (idleTime >= 8) {
          $sessionActive = false;
          $content = '';
          document.querySelector('.writing-content').innerText = $savedContent;
          $screen = 'failed';
        } else if ($elapsed >= $duration) {
          $sessionActive = false;
          $savedContent = $savedContent + $content;
          $content = '';
          const text = $savedContent;
          const chineseChars = (text.match(/[\u4e00-\u9fa5]/g) || []).length;
          const englishWords = (text.match(/[a-zA-Z]+/g) || []).length;
          $wordCount = chineseChars + englishWords;
          $screen = 'success';
        }
      " style="display: none"></div>

    <!-- 文本输入区 -->
    <div class="writing-area" data-class:danger-state="$dangerActive">
      <div class="writing-content" contenteditable="true" data-placeholder="开始输入..." spellcheck="false"
        data-on:input="$lastInputTime = Date.now(); $dangerActive = false; const fullText = el.innerText; $content = fullText.length > $savedContent.length ? fullText.substring($savedContent.length) : ''; el.classList.toggle('has-multiple-lines', fullText.split(/\r?\n/).length > 1); document.getElementById('writing-screen').scrollTop = document.getElementById('writing-screen').scrollHeight"
        data-on:keydown="(evt.key === 'Backspace' || evt.key === 'Delete') && evt.preventDefault()"
        data-on:cut__prevent="true"></div>
    </div>
  </div>

  <!-- 成功界面 (Success Screen) -->
  <div id="success-screen" data-show="$screen === 'success'" style="display: none">
    <div class="success-content">
      <div class="success-text" data-text="$savedContent"></div>
    </div>
    <div class="copy-toast" data-show="$copied">已复制</div>
    <div class="success-actions">
      <button class="btn-primary"
        data-on:click="const text = document.querySelector('.success-text').innerText; const ta = document.createElement('textarea'); ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); $copied = true; setTimeout(() => $copied = false, 2000)">复制</button>
      <select class="duration-dropdown" data-on:change="$duration = parseInt(el.value)">
        <option value="5">5 秒 (测试)</option>
        <option value="180">3 分钟</option>
        <option value="300">5 分钟</option>
        <option value="600">10 分钟</option>
        <option value="900" selected>15 分钟</option>
        <option value="1200">20 分钟</option>
        <option value="1800">30 分钟</option>
        <option value="3600">60 分钟</option>
      </select>
      <button class="btn-primary"
        data-on:click="$screen = 'writing'; $sessionActive = true; $elapsed = 0; $lastInputTime = Date.now(); $dangerActive = false; $copied = false; setTimeout(() => { const el = document.querySelector('.writing-content'); el.innerText = $savedContent; el.focus(); if ($savedContent) { const range = document.createRange(); range.selectNodeContents(el); range.collapse(false); const sel = window.getSelection(); sel.removeAllRanges(); sel.addRange(range); el.classList.toggle('has-multiple-lines', $savedContent.split(/\r?\n/).length > 1); } }, 100)">继续写</button>
    </div>
  </div>

  <!-- 失败界面 (Failed Screen) -->
  <div id="failed-screen" class="centered" data-show="$screen === 'failed'" style="display: none">
    <div class="status-icon failed icon-pop">✗</div>
    <p class="stats-text">本轮文字已清空</p>

    <!-- 有已保存内容时显示 -->
    <div data-show="$savedContent" class="saved-content-section">
      <p class="hint-text">之前保存的内容：</p>
      <div class="saved-preview" data-text="$savedContent"></div>
      <div class="copy-toast" data-show="$copied">已复制</div>
      <button class="btn-secondary"
        data-on:click="const ta = document.createElement('textarea'); ta.value = $savedContent; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); $copied = true; setTimeout(() => $copied = false, 2000)">复制已保存内容</button>
    </div>

    <!-- 无已保存内容时显示 -->
    <p class="hint-text text-blink" data-show="!$savedContent">再试一次？</p>

    <button class="btn-primary"
      data-on:click="$screen = 'idle'; $elapsed = 0; $content = ''; $savedContent = ''; $dangerActive = false">重新开始</button>
  </div>

  <!-- localStorage 持久化 -->
  <div data-effect="
      if ($screen === 'success' && $savedContent) {
        const history = JSON.parse(localStorage.getItem('zerodraft_history') || '[]');
        const exists = history.some(h => h.content === $savedContent);
        if (!exists) {
          history.unshift({
            id: Date.now().toString(),
            content: $savedContent,
            wordCount: $wordCount,
            duration: $duration,
            completedAt: new Date().toISOString(),
            status: 'success'
          });
          if (history.length > 10) history.pop();
          localStorage.setItem('zerodraft_history', JSON.stringify(history));
        }
      }
    " style="display: none"></div>

  <datastar-inspector>hello world</datastar-inspector>

</body>

</html>
